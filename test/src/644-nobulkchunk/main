cvmfs_test_name="Omit bulk chunks"
cvmfs_test_autofs_on_startup=false

cvmfs_run_test() {
  logfile=$1
  local repo_dir=/cvmfs/$CVMFS_TEST_REPO

  echo "*** create a fresh repository named $CVMFS_TEST_REPO with user $CVMFS_TEST_USER"
  create_empty_repo $CVMFS_TEST_REPO $CVMFS_TEST_USER || return $?

  echo "*** create a chunked file"
  start_transaction $CVMFS_TEST_REPO || return $?
  touch /cvmfs/$CVMFS_TEST_REPO/empty
  dd if=/dev/urandom of=/cvmfs/$CVMFS_TEST_REPO/32mb bs=$((1024*1024)) count=32
  local md5_32mb=$(md5sum /cvmfs/$CVMFS_TEST_REPO/32mb | awk '{print $1}')
  echo "*** md5sum of file: $md5_32mb"
  publish_repo $CVMFS_TEST_REPO || return $?

  local chunks=$(get_xattr chunks /var/spool/cvmfs/$CVMFS_TEST_REPO/rdonly/32mb)
  echo "*** number of chunks is $chunks"
  [ $chunks -gt 1 ] || return 10
  local bulk_hash=$(get_xattr hash /var/spool/cvmfs/$CVMFS_TEST_REPO/rdonly/32mb)
  echo "*** empty bulk hash is $bulk_hash"
  [ "x$bulk_hash" != "x" ] || return 12
  [ "x$bulk_hash" != "0000000000000000000000000000000000000000" ] || return 13
  check_repository $CVMFS_TEST_REPO -i || return 14

  echo "*** turn off legacy bulk chunks, republish big file"
  echo "CVMFS_GENERATE_LEGACY_BULK_CHUNKS=false" | \
    sudo tee -a /etc/cvmfs/repositories.d/$CVMFS_TEST_REPO/server.conf
  start_transaction $CVMFS_TEST_REPO || return $?
  touch /cvmfs/$CVMFS_TEST_REPO/32mb
  publish_repo $CVMFS_TEST_REPO || return $?

  get_xattr hash /var/spool/cvmfs/$CVMFS_TEST_REPO/rdonly/32mb && return 20
  check_repository $CVMFS_TEST_REPO -i || return 21

  md5_32mb_chunked=$(md5sum /cvmfs/$CVMFS_TEST_REPO/32mb | awk '{print $1}')
  echo "*** md5sum of file read in chunks: $md5_32mb_chunked"
  [ "x$md5_32mb" = "x$md5_32mb_chunked" ] || return 22

  echo "*** hardlinked, chunked files"
  start_transaction $CVMFS_TEST_REPO || return $?
  dd if=/dev/urandom of=/cvmfs/$CVMFS_TEST_REPO/hl1 bs=$((1024*1024)) count=32
  ln /cvmfs/$CVMFS_TEST_REPO/hl1 /cvmfs/$CVMFS_TEST_REPO/hl2
  local md5_ln=$(md5sum /cvmfs/$CVMFS_TEST_REPO/hl1 | awk '{print $1}')
  echo "*** md5sum of hard link: $md5_ln"
  publish_repo $CVMFS_TEST_REPO || return $?

  chunks=$(get_xattr chunks /var/spool/cvmfs/$CVMFS_TEST_REPO/rdonly/hl1)
  echo "*** number of chunks is $chunks"
  [ $chunks -gt 1 ] || return 30
  get_xattr hash /var/spool/cvmfs/$CVMFS_TEST_REPO/rdonly/ln && return 31
  local md5_ln_chunked=$(md5sum /cvmfs/$CVMFS_TEST_REPO/hl1 | awk '{print $1}')
  echo "*** md5sum of hard link read in chunks: $md5_ln_chunked"
  [ "x$md5_ln" = "x$md5_ln_chunked" ] || return 32
  md5_ln_chunked=$(md5sum /cvmfs/$CVMFS_TEST_REPO/hl2 | awk '{print $1}')
  echo "*** md5sum of other hard link read in chunks: $md5_ln_chunked"
  [ "x$md5_ln" = "x$md5_ln_chunked" ] || return 33

  start_transaction $CVMFS_TEST_REPO || return $?
  ln /cvmfs/$CVMFS_TEST_REPO/hl1 /cvmfs/$CVMFS_TEST_REPO/hl3
  publish_repo $CVMFS_TEST_REPO || return $?
  md5_ln_chunked=$(md5sum /cvmfs/$CVMFS_TEST_REPO/hl3 | awk '{print $1}')
  echo "*** md5sum of new hard link read in chunks: $md5_ln_chunked"
  [ "x$md5_ln" = "x$md5_ln_chunked" ] || return 34

  # TODO replication, gc, libcvmfs

  return 0
}

