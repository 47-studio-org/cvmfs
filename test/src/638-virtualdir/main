cvmfs_test_name="Create Virtual .cvmfs Directory"
cvmfs_test_autofs_on_startup=false


cvmfs_run_test() {
  logfile=$1
  local repo_dir=/cvmfs/$CVMFS_TEST_REPO

  local scratch_dir=$(pwd)

  echo "--- create a fresh repository named $CVMFS_TEST_REPO with user $CVMFS_TEST_USER"
  create_empty_repo $CVMFS_TEST_REPO $CVMFS_TEST_USER || return $?

  echo "--- check catalog and data integrity"
  check_repository $CVMFS_TEST_REPO -i  || return $?

  echo "--- enable virtual directory"
  echo "CVMFS_VIRTUAL_DIR=true" | sudo tee -a /etc/cvmfs/repositories.d/$CVMFS_TEST_REPO/server.conf
  start_transaction $CVMFS_TEST_REPO || return $?
  publish_repo $CVMFS_TEST_REPO || return $?
  ls -lah /cvmfs/$CVMFS_TEST_REPO/.cvmfs || return 20
  check_repository $CVMFS_TEST_REPO -i  || return 21

  echo "--- reuse virtual directory"
  start_transaction $CVMFS_TEST_REPO || return $?
  publish_repo $CVMFS_TEST_REPO || return $?
  ls -lah /cvmfs/$CVMFS_TEST_REPO/.cvmfs || return 30
  check_repository $CVMFS_TEST_REPO -i  || return 31

  echo "--- creating some tags"
  start_transaction $CVMFS_TEST_REPO || return $?
  publish_repo $CVMFS_TEST_REPO -a tag_x || return $?
  start_transaction $CVMFS_TEST_REPO || return $?
  publish_repo $CVMFS_TEST_REPO -a tag_y || return $?
  start_transaction $CVMFS_TEST_REPO || return $?
  publish_repo $CVMFS_TEST_REPO -a tag_z || return $?

  echo "--- look for created tags"
  ls /cvmfs/$CVMFS_TEST_REPO/.cvmfs/snapshots/tag_x || return 40
  ls /cvmfs/$CVMFS_TEST_REPO/.cvmfs/snapshots/tag_y || return 41
  ls /cvmfs/$CVMFS_TEST_REPO/.cvmfs/snapshots/tag_z || return 42

  # Test removal of tags

  # Test only creating / removing tags (without active publishing)

  # Test removeal of virtual catalog

  echo "--- Ensure that special tag names are not listed"
  #ls -la
  #ls /cvmfs/$CVMFS_TEST_REPO/.cvmfs/snapshots/

  return 0
}
