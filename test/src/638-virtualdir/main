cvmfs_test_name="Create Virtual .cvmfs Directory"
cvmfs_test_autofs_on_startup=false

CVMFS_TEST638_REPLICA_NAME=

cleanup() {
  if [ "x$CVMFS_TEST638_REPLICA_NAME" != "x" ]; then
    sudo cvmfs_server rmfs -f $CVMFS_TEST638_REPLICA_NAME
  fi
}


check_no_create_virtualdir() {
  start_transaction $CVMFS_TEST_REPO || return $?
  touch /cvmfs/$CVMFS_TEST_REPO/.cvmfs || return 1
  publish_repo $CVMFS_TEST_REPO && return 2
  abort_transaction $CVMFS_TEST_REPO || return $?

  start_transaction $CVMFS_TEST_REPO || return $?
  ln -s . /cvmfs/$CVMFS_TEST_REPO/.cvmfs || return 10
  publish_repo $CVMFS_TEST_REPO && return 11
  abort_transaction $CVMFS_TEST_REPO || return $?

  start_transaction $CVMFS_TEST_REPO || return $?
  mkdir /cvmfs/$CVMFS_TEST_REPO/.cvmfs || return 20
  publish_repo $CVMFS_TEST_REPO && return 21
  abort_transaction $CVMFS_TEST_REPO || return $?

  start_transaction $CVMFS_TEST_REPO || return $?
  touch /cvmfs/$CVMFS_TEST_REPO/.CVMFS || return 30
  touch /cvmfs/$CVMFS_TEST_REPO/.cvmfs_allowed || return 30
  publish_repo $CVMFS_TEST_REPO || return 31
}


check_no_modify_virtualdir() {
  start_transaction $CVMFS_TEST_REPO || return $?
  sudo touch /cvmfs/$CVMFS_TEST_REPO/.cvmfs || return 30
  publish_repo $CVMFS_TEST_REPO && return 31
  abort_transaction $CVMFS_TEST_REPO || return $?

  start_transaction $CVMFS_TEST_REPO || return $?
  sudo touch /cvmfs/$CVMFS_TEST_REPO/.cvmfs/file || return 40
  publish_repo $CVMFS_TEST_REPO && return 41
  abort_transaction $CVMFS_TEST_REPO || return $?

  start_transaction $CVMFS_TEST_REPO || return $?
  sudo ln -s . /cvmfs/$CVMFS_TEST_REPO/.cvmfs/symlink || return 50
  publish_repo $CVMFS_TEST_REPO && return 51
  abort_transaction $CVMFS_TEST_REPO || return $?

  start_transaction $CVMFS_TEST_REPO || return $?
  sudo mkdir /cvmfs/$CVMFS_TEST_REPO/.cvmfs/dir || return 60
  publish_repo $CVMFS_TEST_REPO && return 61
  abort_transaction $CVMFS_TEST_REPO || return $?

  start_transaction $CVMFS_TEST_REPO || return $?
  sudo rm -rf /cvmfs/$CVMFS_TEST_REPO/.cvmfs || return 70
  publish_repo $CVMFS_TEST_REPO && return 71
  abort_transaction $CVMFS_TEST_REPO || return $?
}


cvmfs_run_test() {
  logfile=$1
  local repo_dir=/cvmfs/$CVMFS_TEST_REPO

  local scratch_dir=$(pwd)

  echo "--- (0) create a fresh repository named $CVMFS_TEST_REPO with user $CVMFS_TEST_USER"
  create_empty_repo $CVMFS_TEST_REPO $CVMFS_TEST_USER || return $?
  start_transaction $CVMFS_TEST_REPO || return $?
  mkdir /cvmfs/$CVMFS_TEST_REPO/nested || return 1
  touch /cvmfs/$CVMFS_TEST_REPO/nested/.cvmfscatalog || return 2
  publish_repo $CVMFS_TEST_REPO || return 3

  echo "--- (1) check catalog and data integrity"
  check_repository $CVMFS_TEST_REPO -i || return $?

  echo "--- (2) check that edits of .cvmfs are forbidden"
  check_no_create_virtualdir || return $?

  echo "--- (3) enable virtual directory"
  echo "CVMFS_VIRTUAL_DIR=true" | sudo tee -a /etc/cvmfs/repositories.d/$CVMFS_TEST_REPO/server.conf
  start_transaction $CVMFS_TEST_REPO || return $?
  publish_repo $CVMFS_TEST_REPO || return $?
  ls -lah /cvmfs/$CVMFS_TEST_REPO/.cvmfs || return 20
  check_repository $CVMFS_TEST_REPO -i  || return 21

  echo "--- (4) check that edits of .cvmfs are still forbidden"
  check_no_modify_virtualdir || return $?

  echo "--- (5) reuse virtual directory"
  start_transaction $CVMFS_TEST_REPO || return $?
  publish_repo $CVMFS_TEST_REPO || return $?
  ls -lah /cvmfs/$CVMFS_TEST_REPO/.cvmfs || return 30
  check_repository $CVMFS_TEST_REPO -i || return 31

  echo "--- (6) look for content in virtual directory"
  local num_vdirs=$(ls /cvmfs/$CVMFS_TEST_REPO/.cvmfs/snapshots | wc -l)
  if [ $num_vdirs -lt 2 ]; then
    return 35
  fi

  echo "--- (7) ensure that special tag names are not listed"
  ls /cvmfs/$CVMFS_TEST_REPO/.cvmfs/snapshots/trunk && return 36
  ls /cvmfs/$CVMFS_TEST_REPO/.cvmfs/snapshots/trunk-previous && return 37

  echo "--- (8) ensure that garbage collection prunes bind mountpoints"
  echo "CVMFS_GARBAGE_COLLECTION=true" | \
    sudo tee -a /etc/cvmfs/repositories.d/$CVMFS_TEST_REPO/server.conf
  start_transaction $CVMFS_TEST_REPO || return $?
  publish_repo $CVMFS_TEST_REPO || return $?
  CVMFS_SERVER_DEBUG=3 cvmfs_server gc -f $CVMFS_TEST_REPO 2>&1 | tee gc-s0.log || return 40
  grep "found root prefix /.cvmfs " gc-s0.log || return 41
  grep "/.cvmfs/snapshots" gc-s0.log && return 42
  check_repository $CVMFS_TEST_REPO -i || return 43

  echo "--- (9) ensure that bind mountpoints are not replicated"
  CVMFS_TEST638_REPLICA_NAME="$(get_stratum1_name $CVMFS_TEST_REPO)"
  load_repo_config $CVMFS_TEST_REPO
  trap cleanup EXIT HUP INT TERM
  create_stratum1 $CVMFS_TEST638_REPLICA_NAME                          \
                  $CVMFS_TEST_USER                       \
                  $CVMFS_STRATUM0                        \
                  /etc/cvmfs/keys/${CVMFS_TEST_REPO}.pub || return 51
  cvmfs_server snapshot $CVMFS_TEST638_REPLICA_NAME | tee snapshot.log || return 51
  grep "Replicating from catalog at /.cvmfs" snapshot.log || return 52
  grep "Replicating from catalog at /.cvmfs/" snapshot.log && return 53
  check_repository $CVMFS_TEST638_REPLICA_NAME -i || return 54
  CVMFS_SERVER_DEBUG=3 cvmfs_server gc -f $CVMFS_TEST638_REPLICA_NAME 2>&1 | tee gc-s1.log || return 55
  grep "found root prefix /.cvmfs " gc-s1.log || return 56
  grep "/.cvmfs/snapshots" gc-s1.log && return 57
  check_repository $CVMFS_TEST638_REPLICA_NAME -i || return 58

  echo "--- (10) ensure that catalog-chown skips virtual catalog"
  local uid_before=$(stat -c %u /cvmfs/$CVMFS_TEST_REPO/.cvmfs/snapshots)
  local gid_before=$(stat -c %g /cvmfs/$CVMFS_TEST_REPO/.cvmfs/snapshots)
  [ "x$uid_before" != "x0" -o "x$gid_before" != "x0" ] && return 60
  echo "0 1" > uidmap
  echo "0 1" > gidmap
  sudo cvmfs_server catalog-chown -u uidmap -g gidmap $CVMFS_TEST_REPO || return 61
  local uid_after=$(stat -c %u /cvmfs/$CVMFS_TEST_REPO/.cvmfs/snapshots)
  local gid_after=$(stat -c %g /cvmfs/$CVMFS_TEST_REPO/.cvmfs/snapshots)
  [ "x$uid_after" != "x0" -o "x$gid_after" != "x0" ] && return 62

  echo "--- creating some tags"
  start_transaction $CVMFS_TEST_REPO || return $?
  publish_repo $CVMFS_TEST_REPO -a tag_x || return $?
  start_transaction $CVMFS_TEST_REPO || return $?
  publish_repo $CVMFS_TEST_REPO -a tag_y || return $?
  start_transaction $CVMFS_TEST_REPO || return $?
  publish_repo $CVMFS_TEST_REPO -a tag_z || return $?

  echo "--- look for created tags"
  ls /cvmfs/$CVMFS_TEST_REPO/.cvmfs/snapshots/tag_x || return 40
  ls /cvmfs/$CVMFS_TEST_REPO/.cvmfs/snapshots/tag_y || return 41
  ls /cvmfs/$CVMFS_TEST_REPO/.cvmfs/snapshots/tag_z || return 42

  # Test removal of tags

  # Test only creating / removing tags (without active publishing)

  # Test same nested catalog mounted at different mount points

  # Test removeal of virtual catalog

  return 0
}
