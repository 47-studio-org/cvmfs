cvmfs_test_name="Catalog balancer"
cvmfs_test_autofs_on_startup=false

add_files() {
  local directory=$1
  local num_files=$2
  mkdir -p "$directory"
  local body="$directory/file"

  for i in $(seq 1 1 $num_files); do
    touch "$body$i"
  done
}

add_catalog() {
  local repo_dir=$1
  touch "$repo_dir/.cvmfscatalog"
}

cvmfs_run_test() {
  apache_switch on
  local repo="test.local"
  local repo_dir="/cvmfs/$repo"

  create_repo "$repo" $(whoami)

  sudo bash -c "echo 'CVMFS_AUTOCATALOGS=true
  CVMFS_AUTOCATALOGS_MAX_WEIGHT=20
  CVMFS_AUTOCATALOGS_MIN_WEIGHT=8' >> /etc/cvmfs/repositories.d/$repo/server.conf"

  start_transaction "$repo"
  add_files "$repo_dir" 25
  add_files "$repo_dir/dir100" 100
  add_files "$repo_dir/dir3" 3
  add_files "$repo_dir/dir4" 4
  add_catalog "$repo_dir/dir4"
  publish_repo "$repo"

  echo "Checking first iteration"
  ! [ -f "$repo_dir/dir3/.cvmfscatalog" ]                     || return 101
  ! [ -f "$repo_dir/dir3/.cvmfsautocatalog" ]                 || return 102
  if check_catalog_presence "/dir3" "$repo"; then return 1001; fi
  ! [ -f "$repo_dir/.cvmfscatalog" ]                          || return 103
  ! [ -f "$repo_dir/.cvmfsautocatalog" ]                      || return 104
  if ! check_catalog_presence "/" "$repo"; then return 1002; fi
    [ -f "$repo_dir/dir100/.cvmfscatalog" ]                   || return 105
    [ -f "$repo_dir/dir100/.cvmfsautocatalog" ]               || return 106
  if ! check_catalog_presence "/dir100" "$repo"; then return 1003; fi
    [ -f "$repo_dir/dir4/.cvmfscatalog" ]                     || return 107
  ! [ -f "$repo_dir/dir4/.cvmfsautocatalog" ]                 || return 108
  if ! check_catalog_presence "/dir4" "$repo"; then return 1004; fi

  start_transaction "$repo"
  add_files "$repo_dir/dir/dir30" 30
  for i in $(ls "$repo_dir" | grep "file"); do
    rm "$repo_dir/$i"
  done
  publish_repo "$repo"

  echo "Checking second iteration"
  ! [ -f "$repo_dir/dir3/.cvmfscatalog" ]                     || return 201
  ! [ -f "$repo_dir/dir3/.cvmfsautocatalog" ]                 || return 202
  if check_catalog_presence "/dir3" "$repo"; then return 2001; fi
  ! [ -f "$repo_dir/.cvmfscatalog" ]                          || return 203
  ! [ -f "$repo_dir/.cvmfsautocatalog" ]                      || return 204
  if ! check_catalog_presence "/" "$repo"; then return 2002; fi
    [ -f "$repo_dir/dir100/.cvmfscatalog" ]                   || return 205
    [ -f "$repo_dir/dir100/.cvmfsautocatalog" ]               || return 206
  if ! check_catalog_presence "/dir100" "$repo"; then return 2003; fi
    [ -f "$repo_dir/dir4/.cvmfscatalog" ]                     || return 207
  ! [ -f "$repo_dir/dir4/.cvmfsautocatalog" ]                 || return 208
  if ! check_catalog_presence "/dir4" "$repo"; then return 2004; fi
    [ -f "$repo_dir/dir/dir30/.cvmfscatalog" ]                || return 209
    [ -f "$repo_dir/dir/dir30/.cvmfsautocatalog" ]            || return 210
  if ! check_catalog_presence "/dir/dir30" "$repo"; then return 2005; fi

  start_transaction "$repo"
  add_files "$repo_dir/dir60" 60
  publish_repo "$repo"

  echo "Checking third iteration"
  ! [ -f "$repo_dir/dir3/.cvmfscatalog" ]                     || return 301
  ! [ -f "$repo_dir/dir3/.cvmfsautocatalog" ]                 || return 302
  if check_catalog_presence "/dir3" "$repo"; then return 3001; fi
  ! [ -f "$repo_dir/.cvmfscatalog" ]                          || return 303
  ! [ -f "$repo_dir/.cvmfsautocatalog" ]                      || return 304
  if ! check_catalog_presence "/" "$repo"; then return 3002; fi
    [ -f "$repo_dir/dir100/.cvmfscatalog" ]                   || return 305
    [ -f "$repo_dir/dir100/.cvmfsautocatalog" ]               || return 306
  if ! check_catalog_presence "/dir100" "$repo"; then return 3003; fi
    [ -f "$repo_dir/dir4/.cvmfscatalog" ]                     || return 307
  ! [ -f "$repo_dir/dir4/.cvmfsautocatalog" ]                 || return 308
  if ! check_catalog_presence "/dir4" "$repo"; then return 3004; fi
    [ -f "$repo_dir/dir/dir30/.cvmfscatalog" ]                || return 309
    [ -f "$repo_dir/dir/dir30/.cvmfsautocatalog" ]            || return 310
  if ! check_catalog_presence "/dir/dir30" "$repo"; then return 3005; fi
    [ -f "$repo_dir/dir60/.cvmfscatalog" ]                    || return 311
    [ -f "$repo_dir/dir60/.cvmfsautocatalog" ]                || return 312
  if ! check_catalog_presence "/dir60" "$repo"; then return 3006; fi

  start_transaction "$repo"
  for i in $(ls $repo_dir/dir60 | grep "file"); do
    rm "$repo_dir/dir60/$i"
  done
  add_files "$repo_dir/dir60" 1
  publish_repo "$repo"

  echo "Checking fourth iteration"
  ! [ -f "$repo_dir/dir3/.cvmfscatalog" ]                     || return 401
  ! [ -f "$repo_dir/dir3/.cvmfsautocatalog" ]                 || return 402
  if check_catalog_presence "/dir3" "$repo"; then return 4001; fi
  ! [ -f "$repo_dir/.cvmfscatalog" ]                          || return 403
  ! [ -f "$repo_dir/.cvmfsautocatalog" ]                      || return 404
  if ! check_catalog_presence "/" "$repo"; then return 4002; fi
    [ -f "$repo_dir/dir100/.cvmfscatalog" ]                   || return 405
    [ -f "$repo_dir/dir100/.cvmfsautocatalog" ]               || return 406
  if ! check_catalog_presence "/dir100" "$repo"; then return 4003; fi
    [ -f "$repo_dir/dir4/.cvmfscatalog" ]                     || return 407
  ! [ -f "$repo_dir/dir4/.cvmfsautocatalog" ]                 || return 408
  if ! check_catalog_presence "/dir4" "$repo"; then return 4004; fi
    [ -f "$repo_dir/dir/dir30/.cvmfscatalog" ]                || return 409
    [ -f "$repo_dir/dir/dir30/.cvmfsautocatalog" ]            || return 410
  if ! check_catalog_presence "/dir/dir30" "$repo"; then return 4005; fi
  ! [ -f "$repo_dir/dir60/.cvmfscatalog" ]                    || return 411
  ! [ -f "$repo_dir/dir60/.cvmfsautocatalog" ]                || return 412
  if check_catalog_presence "/dir60" "$repo"; then return 4006; fi


  start_transaction "$repo"
  # now suppose the user creates a '.cvmfsautocatalog' file
  touch "$repo_dir/dir4/.cvmfsautocatalog"
  # now the system should get rid of the catalog in /dir4 and delete both entries
  publish_repo "$repo"

  echo "Checking fifth iteration"
  ! [ -f "$repo_dir/dir3/.cvmfscatalog" ]                     || return 501
  ! [ -f "$repo_dir/dir3/.cvmfsautocatalog" ]                 || return 502
  if check_catalog_presence "/dir3" "$repo"; then return 5001; fi
  ! [ -f "$repo_dir/.cvmfscatalog" ]                          || return 503
  ! [ -f "$repo_dir/.cvmfsautocatalog" ]                      || return 504
  if ! check_catalog_presence "/" "$repo"; then return 5002; fi
    [ -f "$repo_dir/dir100/.cvmfscatalog" ]                   || return 505
    [ -f "$repo_dir/dir100/.cvmfsautocatalog" ]               || return 506
  if ! check_catalog_presence "/dir100" "$repo"; then return 5003; fi
  ! [ -f "$repo_dir/dir4/.cvmfscatalog" ]                     || return 507
  ! [ -f "$repo_dir/dir4/.cvmfsautocatalog" ]                 || return 508
  if check_catalog_presence "/dir4" "$repo"; then return 5004; fi
    [ -f "$repo_dir/dir/dir30/.cvmfscatalog" ]                || return 509
    [ -f "$repo_dir/dir/dir30/.cvmfsautocatalog" ]            || return 510
  if ! check_catalog_presence "/dir/dir30" "$repo"; then return 5005; fi
  ! [ -f "$repo_dir/dir60/.cvmfscatalog" ]                    || return 511
  ! [ -f "$repo_dir/dir60/.cvmfsautocatalog" ]                || return 512
  if check_catalog_presence "/dir60" "$repo"; then return 5006; fi

  destroy_repo "$repo"
}
