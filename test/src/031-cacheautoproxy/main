
cvmfs_test_name="Cache result of proxy auto discovery"

cvmfs_run_test() {
  logfile=$1

  local wpad_file="$(pwd)/wpad"
  cat > $wpad_file << EOF
  function FindProxyForURL(url, host) {
    return "PROXY http://no-such-proxy.cern.ch:3128"
  }
EOF
  chmod 666 $wpad_file || return 10

  cvmfs_mount grid.cern.ch || return 11
  cvmfs_umount grid.cern.ch || return 12

  cvmfs_mount grid.cern.ch "CVMFS_HTTP_PROXY=auto" \
    "CVMFS_PAC_URLS=file://$wpad_file" || return 20
  proxy="$(get_xattr proxy /cvmfs/grid.cern.ch)"
  echo "*** proxy is $proxy"
  if [ x"$proxy" != x"http://no-such-proxy.cern.ch:3128" ]; then
    return 21
  fi
  cvmfs_umount grid.cern.ch

  cvmfs_mount grid.cern.ch "CVMFS_HTTP_PROXY=auto" \
    "CVMFS_PAC_URLS=file:///no/such/file" || return 30
  proxy="$(get_xattr proxy /cvmfs/grid.cern.ch)"
  echo "*** proxy is $proxy"
  if [ x"$proxy" != x"http://no-such-proxy.cern.ch:3128" ]; then
    return 31
  fi

  return 0
}

