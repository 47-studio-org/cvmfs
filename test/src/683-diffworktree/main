cvmfs_test_name="Set base hash in diff command"
cvmfs_test_autofs_on_startup=false
cvmfs_test_suites="quick"

cvmfs_run_test() {
  logfile=$1

  echo "*** Create a new repository"
  create_empty_repo $CVMFS_TEST_REPO $CVMFS_TEST_USER || return 1

  echo "*** Start a transaction with default hash algorithm"
  start_transaction $CVMFS_TEST_REPO || return 8
  echo "*** Edit repository"
  touch /cvmfs/$CVMFS_TEST_REPO/new_file.txt || return 3
  echo "*** Run diff command"
  cvmfs_server diff --worktree $CVMFS_TEST_REPO || return 4
  echo "*** Abort transaction"
  abort_transaction $CVMFS_TEST_REPO || return 5

  echo "*** Change hash algorithm to shake128"
  cd /etc/cvmfs/repositories.d/$CVMFS_TEST_REPO/ || return 6
  if grep -q "sha1" server.conf; then 
    sed -i 's/sha1/shake128/' server.conf || return 7
  fi

  echo "*** Empty transaction for saving settings"
  start_transaction $CVMFS_TEST_REPO || return 8
  cvmfs_server publish $CVMFS_TEST_REPO || return 9

  echo "*** Start transaction"
  start_transaction $CVMFS_TEST_REPO || return 10
  echo "*** Edit repository"
  touch /cvmfs/$CVMFS_TEST_REPO/new_file.txt || return 11
  echo "*** Run diff command"
  cvmfs_server diff --worktree $CVMFS_TEST_REPO || return 12
  echo "*** Abort transaction"
  abort_transaction $CVMFS_TEST_REPO

  echo "*** Change hash algorithm to rmd160"
  cd /etc/cvmfs/repositories.d/$CVMFS_TEST_REPO/ || return 6
  if grep -q "shake128" server.conf; then
    sed -i 's/shake128/rmd160/' server.conf || return 7
  fi

  echo "*** Empty transaction for saving settings"
  start_transaction $CVMFS_TEST_REPO || return 8
  cvmfs_server publish $CVMFS_TEST_REPO || return 9

  echo "*** Start transaction"
  start_transaction $CVMFS_TEST_REPO || return 10
  echo "*** Edit repository"
  touch /cvmfs/$CVMFS_TEST_REPO/new_file.txt || return 11
  echo "*** Run diff command"
  cvmfs_server diff --worktree $CVMFS_TEST_REPO || return 12
  echo "*** Abort transaction"
  abort_transaction $CVMFS_TEST_REPO

  return 0
}

