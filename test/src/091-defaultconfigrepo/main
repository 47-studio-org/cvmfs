cvmfs_test_name="Test CVMFS with external cache plugins"
cvmfs_test_suites="quick"

CVMFS_TEST091_CONFIG=

cleanup() {
  if [ "x$CVMFS_TEST091_CONFIG" != "x" ]; then
    sudo rm -f $CVMFS_TEST091_CONFIG
  fi
}

cvmfs_run_test() {
  logfile=$1

  trap cleanup EXIT HUP INT TERM

  CVMFS_TEST091_CONFIG=/etc/cvmfs/default.d/99-test091.conf
  echo "CVMFS_CONFIG_REPOSITORY=cvmfs-config.cern.ch" | sudo tee $CVMFS_TEST091_CONFIG

  echo "*** check availability of default cvmfs-config.cern.ch repository"
  cvmfs_mount cms.cern.ch || return 1
  cvmfs_config showconfig cms.cern.ch | grep ^CVMFS_CONFIG_REPOSITORY= \
    | grep cvmfs-config.cern.ch || return 2
  ls /cvmfs/cvmfs-config.cern.ch || return 3

  sudo rm -f $CVMFS_TEST091_CONFIG
  CVMFS_TEST091_CONFIG=

  echo "*** check OpenHTC servers"
  get_xattr host /cvmfs/cms.cern.ch | grep openhtc && return 20

  cvmfs_mount grid.cern.ch CVMFS_USE_OPENHTC=yes || return 10
  cvmfs_config showconfig grid.cern.ch | grep ^CVMFS_CONFIG_REPOSITORY= \
    | grep cvmfs-config-test.cern.ch || return 11
  ls /cvmfs/cvmfs-config-test.cern.ch || return 12
  get_xattr host /cvmfs/grid.cern.ch | grep openhtc || return 13

  echo "*** check proxy auto config"
  cvmfs_mount cernvm-prod.cern.ch CVMFS_CLIENT_PROFILE=single CVMFS_HTTP_PROXY= || return 30
  cvmfs_config showconfig cernvm-prod.cern.ch | grep ^CVMFS_HTTP_PROXY= |\
    grep auto | grep cvmfs-config-test.cern.ch || return 31

  echo "*** check that a decision on the proxy must be taken"
  cvmfs_mount alice.cern.ch CVMFS_HTTP_PROXY= && return 40

  return 0
}
