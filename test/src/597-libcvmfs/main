cvmfs_test_name="Libcvmfs test"
cvmfs_test_autofs_on_startup=false

cvmfs_run_test() {
  local workdir="$2"
  # compile the source first
  local bin_name="597-test"
  g++ -o "$bin_name" -DDEBUGMSG "$workdir/main.cc" -lcvmfs -pthread -ldl -lssl -lcrypto -luuid -lrt

  apache_switch on
  local num_repos=5
  local base_name="local.libcvmfs_test_"
  for i in $(seq 1 $num_repos); do
    local repo_name="$base_name$i"
    local repo_dir="/cvmfs/$repo_name"

    create_repo "$repo_name" $(whoami)
    start_transaction "$repo_name"

    rm $repo_dir/*  # cleanup the repository before starting
    mkdir "$repo_dir/main"
    echo "$i" > "$repo_dir/main/mainfile"

    mkdir "$repo_dir/list"
    for j in $(seq 1 $i); do
      touch "$repo_dir/list/file$j"
    done

    publish_repo "$repo_name"
  done

  # check libcvmfs with the generated binary
  "./$bin_name" "$base_name" "$num_repos"
  return_code=$?

  for i in $(seq 1 $num_repos); do
    destroy_repo "$base_name$i"
  done

  return $return_code
}
