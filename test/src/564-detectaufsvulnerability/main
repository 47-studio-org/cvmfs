cvmfs_test_name="Detect AUFS Kernel Deadlock Vulnerability"
cvmfs_test_autofs_on_startup=false

# see if the kernel should be vulnerable in the first place
# Note: This is a simplified version of what is checked in `cvmfs_server`
is_kernel_vulnerable() {
  # threshold definitions
  local krnl_minimum_required="3.10.0"
  local krnl_sl6_minimal_fixed="431.29.2"

  local krnl_version="$(uname -r | cut --delimiter='-' --fields=1)"
  if compare_versions "$krnl_version" -ge "$krnl_minimum_required"; then
    return 1 # no problem, Linux kernel is recent enough (AUFS should be as well)
  fi

  # check if we are running the custom SL6 kernel (and if it is recent enough)
  if uname -r | grep -q "el6.aufs"; then
    local krnl_revision="$(uname -r | sed 's/^.*-\([0-9]\+\.[0-9]\+\.[0-9]\+\)\..*/\1/')"
    if compare_versions "$krnl_revision" -ge "$krnl_sl6_minimal_fixed"; then
      return 1 # kernel contains the AUFS workaround fix
    fi
  fi

  return 0
}

cvmfs_run_test() {
  logfile=$1
  local repo_dir=/cvmfs/$CVMFS_TEST_REPO
  local krnl_vulnerable=1

  echo "check if kernel is vulnerable in the first place"
  local krnl_version="$(uname -r | cut --delimiter='-' --fields=1)"
  local krnl_major="$(version_major $krnl_version)"
  local krnl_minor="$(version_minor $krnl_version)"
  if [ $krnl_major -gt 3 ] || [ $krnl_major -eq 3 -a $krnl_minor -ge 10 ]; then
    echo "--> Kernel is not vulnerable per se... nothing to expect here"
    krnl_vulnerable=0
  fi

  echo "create a fresh repository named $CVMFS_TEST_REPO with user $CVMFS_TEST_USER that might be vulnerable"
  local old_server_cache_setting=$CVMFS_TEST_SERVER_CACHE
  export CVMFS_TEST_SERVER_CACHE=""
  create_empty_repo $CVMFS_TEST_REPO $CVMFS_TEST_USER || return $?
  export CVMFS_TEST_SERVER_CACHE=$old_server_cache_setting

  echo "starting transaction to check for warning message"
  if ! start_transaction $CVMFS_TEST_REPO 2>&1 | grep -q 'WARNING: AUFS config is vulnerable'; then
    if [ $krnl_vulnerable -eq 1 ]; then
      return 1
    else
      echo "kernel is not vulnerable and error message didn't show up"
    fi
  fi

  echo "aborting transaction"
  abort_transaction $CVMFS_TEST_REPO || return 2

  echo "add silence configuration flag"
  echo "CVMFS_AUFS_WARNING=false" | sudo tee --append /etc/cvmfs/repositories.d/${CVMFS_TEST_REPO}/server.conf

  echo "starting transaction to check for warning message to be gone"
  start_transaction $CVMFS_TEST_REPO 2>&1 | grep -q 'WARNING: AUFS config is vulnerable' && return 3

  echo "aborting transaction"
  abort_transaction $CVMFS_TEST_REPO || return 4

  echo "create a new repository that is not vulnerable"
  create_empty_repo $CVMFS_TEST_REPO $CVMFS_TEST_USER || return $?

  echo "starting transaction to check for absence of warning message"
  start_transaction $CVMFS_TEST_REPO 2>&1 | grep -q 'WARNING: AUFS config is vulnerable' && return 5

  echo "aborting transaction"
  abort_transaction $CVMFS_TEST_REPO || return 6

  return 0
}

