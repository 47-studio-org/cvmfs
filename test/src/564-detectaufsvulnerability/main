cvmfs_test_name="Detect AUFS Kernel Deadlock Vulnerability"
cvmfs_test_autofs_on_startup=false

cvmfs_run_test() {
  logfile=$1
  local repo_dir=/cvmfs/$CVMFS_TEST_REPO
  local krnl_vulnerable=1

  echo "check if kernel is vulnerable in the first place"
  local krnl_version="$(uname -r | cut --delimiter='-' --fields=1)"
  local krnl_major="$(version_major $krnl_version)"
  local krnl_minor="$(version_minor $krnl_version)"
  if [ $krnl_major -gt 3 ] || [ $krnl_major -eq 3 -a $krnl_minor -ge 10 ]; then
    echo "--> Kernel is not vulnerable per se... nothing to expect here"
    krnl_vulnerable=0
  fi

  echo "create a fresh repository named $CVMFS_TEST_REPO with user $CVMFS_TEST_USER that might be vulnerable"
  local old_server_cache_setting=$CVMFS_TEST_SERVER_CACHE
  export CVMFS_TEST_SERVER_CACHE=""
  create_empty_repo $CVMFS_TEST_REPO $CVMFS_TEST_USER || return $?
  export CVMFS_TEST_SERVER_CACHE=$old_server_cache_setting

  echo "starting transaction to check for warning message"
  if ! start_transaction $CVMFS_TEST_REPO 2>&1 | grep -q 'WARNING: AUFS config is vulnerable'; then
    if [ $krnl_vulnerable -eq 1 ]; then
      return 1
    else
      echo "kernel is not vulnerable and error message didn't show up"
    fi
  fi

  echo "aborting transaction"
  abort_transaction $CVMFS_TEST_REPO || return 2

  echo "add silence configuration flag"
  echo "CVMFS_AUFS_WARNING=false" | sudo tee --append /etc/cvmfs/repositories.d/${CVMFS_TEST_REPO}/server.conf

  echo "starting transaction to check for warning message to be gone"
  start_transaction $CVMFS_TEST_REPO 2>&1 | grep -q 'WARNING: AUFS config is vulnerable' && return 3

  echo "aborting transaction"
  abort_transaction $CVMFS_TEST_REPO || return 4

  echo "create a new repository that is not vulnerable"
  create_empty_repo $CVMFS_TEST_REPO $CVMFS_TEST_USER || return $?

  echo "starting transaction to check for absence of warning message"
  start_transaction $CVMFS_TEST_REPO 2>&1 | grep -q 'WARNING: AUFS config is vulnerable' && return 5

  echo "aborting transaction"
  abort_transaction $CVMFS_TEST_REPO || return 6

  return 0
}

