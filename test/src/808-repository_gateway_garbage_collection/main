cvmfs_test_name="Repository gateway"
cvmfs_test_autofs_on_startup=false
cvmfs_test_suites="quick"


clean_up() {
    echo "Cleaning up"

    echo "  Removing output directories"
    rm -rvf /tmp/cvmfs_out_*
}


run_transactions() {
    echo "Running transactions"
}

cvmfs_run_test() {
    trap clean_up EXIT HUP INT TERM || return $?

    set_up_repository_gateway
    toggle_gc test.repo.org

    echo "  Starting transaction 1"
    cvmfs_server transaction test.repo.org

    echo "  Writing to a new file"
    echo "test" >> /cvmfs/test.repo.org/test1.txt
    echo "test" >> /cvmfs/test.repo.org/test2.txt
    echo "test a" >> /cvmfs/test.repo.org/a.txt
    echo "test b" >> /cvmfs/test.repo.org/b.txt
    echo "test c" >> /cvmfs/test.repo.org/c.txt
    echo "test d" >> /cvmfs/test.repo.org/d.txt

    echo "  Appending to a file"
    echo "test" >> /cvmfs/test.repo.org/new_repository

    echo "  Publishing changes 1"
    cvmfs_server publish test.repo.org

    # the gc can run a dry run
    cvmfs_server gc -d -f test.repo.org || return 101

    # a normal, empty GC can run
    # it is empty because we ask to preserver 10 revision
    cvmfs_server gc -r 10 -f test.repo.org || return 102

    # an empty GC can run
    # it is empty since there is noting to delete
    cvmfs_server gc -r 0 -f test.repo.org || return 103

    # let's delete some file
    echo "  Starting transaction 2 to delete files"
    cvmfs_server transaction test.repo.org

    rm /cvmfs/test.repo.org/b.txt
    rm /cvmfs/test.repo.org/c.txt

    echo "  Publishing changes 2"
    cvmfs_server publish test.repo.org

    # the gc can run a dry run
    cvmfs_server gc -d -f test.repo.org || return 104

    # a normal, empty GC can run
    # it is empty because we ask to preserver 10 revision
    cvmfs_server gc -r 10 -f test.repo.org || return 105

    # a normal GC can run
    cvmfs_server gc -r 0 -f test.repo.org || return 106

    return 0
}

